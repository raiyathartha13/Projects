<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>QR Redirect</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script>
      (function () {
        const params = new URLSearchParams(window.location.search);
        const cid = params.get("cid");
        const dest = params.get("dest");
        if (!cid) return;

        const KEY = "DYNAMIC_QR_DB";
        let data = [];
        try {
          data = JSON.parse(localStorage.getItem(KEY) || "[]");
        } catch (err) {
          data = [];
        }

        const campaign = data.find(
          (c) => c.id === cid && c.active !== false && c.url
        );
        if (campaign) {
          campaign.scans = (campaign.scans || 0) + 1;
          campaign.lastScan = new Date().toISOString();
          campaign.lastUTM = {
            source: params.get("utm_source"),
            medium: params.get("utm_medium"),
            campaign: params.get("utm_campaign"),
          };
          campaign.trend = Array.isArray(campaign.trend)
            ? campaign.trend
            : [];
          const nextPoint = Math.min(22, 4 + (campaign.scans % 18));
          campaign.trend.push(nextPoint);
          campaign.trend = campaign.trend.slice(-10);
          localStorage.setItem(KEY, JSON.stringify(data));
          window.location.replace(campaign.url);
          return;
        }

        if (dest && /^https?:\/\//.test(dest)) {
          window.location.replace(dest);
          return;
        }

        document.documentElement.style.display = "none";
      })();
    </script>
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        background: #fff;
      }
    </style>
  </head>
  <body></body>
</html>
